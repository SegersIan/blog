<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Why you should stop using env variables for NPM modules | blog.SegersIan.com</title>
    <meta name="description" content="Personal blog of Segers Ian">
    <meta name="generator" content="VuePress 1.3.1">
    
    
    <link rel="preload" href="/assets/css/0.styles.26cb1efd.css" as="style"><link rel="preload" href="/assets/js/app.e8200553.js" as="script"><link rel="preload" href="/assets/js/2.e277ea22.js" as="script"><link rel="preload" href="/assets/js/16.260776c4.js" as="script"><link rel="prefetch" href="/assets/js/10.864467f4.js"><link rel="prefetch" href="/assets/js/11.0530784f.js"><link rel="prefetch" href="/assets/js/12.af0c1484.js"><link rel="prefetch" href="/assets/js/13.e12d6d64.js"><link rel="prefetch" href="/assets/js/14.7a277a39.js"><link rel="prefetch" href="/assets/js/15.d7df531b.js"><link rel="prefetch" href="/assets/js/17.5ac463a7.js"><link rel="prefetch" href="/assets/js/18.aaf47dbe.js"><link rel="prefetch" href="/assets/js/19.a3968107.js"><link rel="prefetch" href="/assets/js/3.a1f1c6de.js"><link rel="prefetch" href="/assets/js/4.c22c801f.js"><link rel="prefetch" href="/assets/js/5.b396db70.js"><link rel="prefetch" href="/assets/js/6.2e9d4772.js"><link rel="prefetch" href="/assets/js/7.320bda12.js"><link rel="prefetch" href="/assets/js/8.56683158.js"><link rel="prefetch" href="/assets/js/9.bda84d45.js">
    <link rel="stylesheet" href="/assets/css/0.styles.26cb1efd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">blog.SegersIan.com</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="why-you-should-stop-using-env-variables-for-npm-modules"><a href="#why-you-should-stop-using-env-variables-for-npm-modules" class="header-anchor">#</a> Why you should stop using env variables for NPM modules</h1> <p>(Published originally 01.01.2019 on <a href="https://medium.com/@segersian/why-you-should-stop-using-env-variables-for-npm-modules-8bf68717d81d" target="_blank" rel="noopener noreferrer">Medium<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</p> <p>Recently I was reading through the readme of an NPM module on GitHub. As I was skimming through the configuration chapter, a big table of about 14 environment variables caught my attention. Holy *****!</p> <p>Now, the number of environment variables was (fairly) extensive for a simple NPM module, although it’s not unusual to have an extensive configuration for a module/library, why even use environment variables at all?</p> <p><strong>Why Not?</strong></p> <p>Let’s have first a look at the call site of a fictional NPM module <code>custom-logger</code> which is a simple <code>express</code> middleware used to log requests.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'custom-logger'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">{</span> level <span class="token operator">:</span> <span class="token string">'info'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>On the server bootstrap phase, we configure the <code>custom-logger</code> with a log level of <code>info</code>.
Cool, now we’re ready to run our express server. We have a clear configuration of the <code>custom-logger</code>. It’s predictable and clear.</p> <p>One day, we decide to configure the <code>level</code> of the <code>custom-logger</code> . Let’s say we still have the same call site:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'custom-logger'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">{</span> level <span class="token operator">:</span> <span class="token string">'info'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>But before we start our <code>express</code> server, we modify the <code>level</code> via the <code>custom-logger</code> defined environment variable:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">CUSTOM_LOGGER_LEVEL</span><span class="token operator">=</span>debug
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>A question arises <strong>“On what level will we log? Info? Or Debug?”</strong>. Our experience tells us to consult the docs or skim the source code.</p> <p>Any user of the <code>custom-logger</code> should not be skimming the source code, as a proper defined module should not require the user of that module to know the implementation details and inner workings.</p> <p>Then what is wrong with consulting the docs? When you create a module, the usage should be as intuitive as possible,
therefore to make the usage of it <em>pure and deterministic</em>.
The module should not change behaviour because of a change or condition that is not explicit in your code.
When I say “your code”, I mean the call site of the NPM module in our <code>express</code> server.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'custom-logger'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">{</span> level <span class="token operator">:</span> <span class="token string">'info'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Docs are definitely useful and important, but it should not be the band-aid for a bad, unintuitive API of a module.</p> <p><strong>Docs are definitely useful and important, but it should not be the band-aid for a bad, unintuitive API of a module.</strong></p> <p>No, not at all, but a reusable 3th party module like the custom-logger should be environment agnostic. When you are developing your application, you should take full control of how the you supply the configuration of the given NPM modules that you use. Environment variables are a I/O interface that should be fully controlled by you, the developer, with the aid of the <strong>Dependency Inversion Principle.</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'custom-logger'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">{</span> level <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">LOG_LEVEL</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Now we took control of the <code>I/O</code> layer by injecting the configuration to given NPM module from our code.
We also have the freedom to change the name of the environment variable or even the source itself,
maybe we want to read it from a <code>config</code> file instead.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'custom-logger'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./my-config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">{</span> level <span class="token operator">:</span> config<span class="token punctuation">.</span>logLevel <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>The additional advantage we get out of this is, we avoid the “decisions” of the <code>custom-logger</code> authors to bleed into
our application and operations. An example of this would be that we have the names of the environment variables dictated by the NPM module.
They might have decided on another naming convention than yours.
Your code, architecture and operations should not be influenced by used tools and libraries.</p> <p><strong>But what if I want to change the configuration at runtime?</strong></p> <p>You got me there, somewhat. There is no guarantee that changes at runtime of an environment variable will be picked up by a library either, as this is implementation specific. In addition to that, it’s is common for developers to restart their service after the configuration was modified, as changing the configuration at run time can cause unpredictable behaviour of your service.</p> <p><strong>Conclusion</strong></p> <p>There is nothing wrong with environment variables for configuration, but do avoid using or supporting the configuration of modules/libraries (not only NPM) through environment variables, as this should be a concern and freedom of the user of the module/library and you don’t want implementation details of 3th party modules to bleed in your code base.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e8200553.js" defer></script><script src="/assets/js/2.e277ea22.js" defer></script><script src="/assets/js/16.260776c4.js" defer></script>
  </body>
</html>
